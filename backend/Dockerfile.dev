FROM ubuntu:24.04

# Prepare deps
RUN apt-get update -y
RUN apt-get install -y build-essential ninja-build wget git autoconf libtool pkg-config curl libpcap-dev libssl-dev libboost-log-dev

# Download a newer cmake than the ubuntu one (it's laughably old)  
RUN wget -q -O cmake-linux.sh https://github.com/Kitware/CMake/releases/download/v3.19.6/cmake-3.19.6-Linux-x86_64.sh
RUN mkdir /opt/cmake /opt/grpc
RUN sh cmake-linux.sh -- --skip-license --prefix=/opt/cmake
RUN rm cmake-linux.sh

# Download and install grpc
WORKDIR /opt
RUN git clone --recurse-submodules -b v1.60.0 --depth 1 --shallow-submodules https://github.com/grpc/grpc
WORKDIR /opt/grpc
RUN git submodule update
RUN mkdir /opt/grpc/cmake/build
WORKDIR /opt/grpc/cmake/build
RUN /opt/cmake/bin/cmake -DgRPC_INSTALL=ON -DgRPC_BUILD_TESTS=OFF ../..
RUN make -j 4
RUN make install
RUN rm -rf /opt/grpc

# Download and install libtins
WORKDIR /opt
RUN git clone https://github.com/mfontanini/libtins
RUN mkdir /opt/libtins/build
WORKDIR /opt/libtins/build
RUN /opt/cmake/bin/cmake .. -DLIBTINS_ENABLE_CXX11=1 -DLIBTINS_ENABLE_ACK_TRACKER=0
RUN make -j 4
RUN make install
RUN rm -rf /opt/libtins

# Make sure that we can run effectively
WORKDIR /opt
RUN echo ' \
	#!/bin/bash\n \
	protoc -I /opt/app/protos --grpc_out=/opt/app/backend/src --plugin=protoc-gen-grpc=`which grpc_cpp_plugin` /opt/app/protos/packets.proto && protoc -I /opt/app/protos --cpp_out=/opt/app/backend/src /opt/app/protos/packets.proto && /opt/cmake/bin/cmake -G Ninja -B /opt/build /opt/app/backend && ninja -C /opt/build && /opt/build/sniffsniff $*' \
	>> run.sh

# Download the envoy proxy
RUN mkdir /opt/envoy
RUN wget -q -O /opt/envoy/envoy https://github.com/envoyproxy/envoy/releases/download/v1.29.0/envoy-1.29.0-linux-x86_64
RUN chmod +x /opt/envoy/envoy

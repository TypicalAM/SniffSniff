# syntax=docker/dockerfile:1

FROM phusion/baseimage:jammy-1.0.1

# Copy the binaries and libs from the builder
COPY --from=typicalam/sniffsniff-build:v0.1 /app/deps /app/deps

# Prepare runtime deps
RUN apt-get update \
	&& apt-get install -y --no-install-recommends build-essential=12.9ubuntu3 ninja-build=1.10.1-1 libpcap-dev=1.10.1-4build1 libssl-dev=3.0.2-0ubuntu1.13 \
	&& apt-get clean \
	&& rm -rf /var/lib/apt/lists/*

# Create the run script
COPY <<EOF ./run.sh
#!/bin/bash
export PATH="/app/deps/bin:$PATH"
protoc -I /app/src/protos --grpc_out=/app/src/backend/src --plugin=protoc-gen-grpc=$(which grpc_cpp_plugin) /app/src/protos/packets.proto && \
protoc -I /app/src/protos --cpp_out=/app/src/backend/src /app/src/protos/packets.proto && \
/app/deps/bin/cmake -DCMAKE_PREFIX_PATH=/app/deps -G Ninja -B /app/build /app/src/backend && \
ninja -C /app/build && \
/app/build/sniffsniff \$*
EOF
